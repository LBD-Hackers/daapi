{"version":3,"file":"Catalog.js","names":["Catalog","constructor","session","url","fetch","accessService","AccessService","dataService","DataService","queryEngine","QueryEngine","checkExistence","status","method","then","result","create","makePublic","triples","data","DCAT","Dataset","triple","o","object","startsWith","predicate","writeFileToPod","Buffer","from","addMetadata","query","subject","update","getContainment","as","recursive","Promise","resolve","reject","getContainerStructure","LDP","contains","dataset","error","getLocalSparqlEndpoint","getSatelliteFromLdpResource","aggregateSparqlEndpoints","satellite","sources","queryBindings","bindings","toArray","i","map","v","get","value","satellites","Set","ds","sat","add","alias","Array","aggregate","all","s","d","localDatasets","forEach","engine","queryStart","distribution","downloadURL","quadStream","queryQuads","lenient","textStream","rdfSerializer","serialize","contentType","asTtl","streamToString","addDataset","datasetUrl","getRoot","v4","deleteDataset","deleteFile","addDistribution","distributionUrl","deleteDistribution","delete","sparqlUpdate"],"sources":["../../src/Catalog.ts"],"sourcesContent":["import AccessService from \"./helpers/access-service\";\r\nimport DataService from \"./helpers/data-service\";\r\nimport { QueryEngine } from '@comunica/query-sparql'\r\nimport { ACL, DCAT, DCTERMS, FOAF, RDFS, LDP } from \"@inrupt/vocab-common-rdf\";\r\nimport { Session as BrowserSession } from \"@inrupt/solid-client-authn-browser\";\r\nimport { Session as NodeSession } from \"@inrupt/solid-client-authn-node\";\r\nimport rdfSerializer from 'rdf-serialize';\r\nimport {streamToString} from \"./helpers/functions\"\r\nimport { metadata, TokenSession } from './helpers/interfaces'\r\nimport { getSatelliteFromLdpResource } from \"./helpers/functions\";\r\nimport { getRoot } from \"./helpers/functions\";\r\nimport {v4} from \"uuid\"\r\n\r\nexport default class Catalog {\r\n  public fetch;\r\n  public accessService: AccessService;\r\n  public dataService: DataService;\r\n  public projectId: string;\r\n  public url: string;\r\n  public data: object[];\r\n  public session: BrowserSession | NodeSession | TokenSession\r\n  public queryEngine: any\r\n\r\n  constructor(session: BrowserSession | NodeSession | TokenSession, url: string) {\r\n    this.session = session\r\n    this.fetch = session.fetch;\r\n    this.url = url\r\n    this.accessService = new AccessService(session.fetch);\r\n    this.dataService = new DataService(session.fetch);\r\n    this.queryEngine = new QueryEngine()\r\n  }\r\n\r\n  /**\r\n   * \r\n   * @returns boolean: this catalog exists or not\r\n   */\r\n  public async checkExistence() {\r\n    const status = await this.fetch(this.url, { method: \"HEAD\" }).then(result => result.status)\r\n    if (status === 200) {\r\n      return true\r\n    } else {\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @description create this dataset within the active project\r\n   * @param makePublic initial access rights for the dataset (boolean)\r\n   */\r\n  public async create(makePublic, triples: metadata[] = []): Promise<void> {\r\n    let data = `\r\n      <> a <${DCAT.Catalog}>, <${DCAT.Dataset}> .\r\n\r\n    `\r\n\r\n    for (const triple of triples) {\r\n      let o\r\n      if (triple.object.startsWith(\"http\")) {\r\n        o = `<${triple.object}>`\r\n      } else {\r\n        o = `\"${triple.object}\"`\r\n      }\r\n      data += `<> <${triple.predicate}> ${o} .`\r\n    }\r\n    await this.dataService.writeFileToPod(Buffer.from(data), this.url, makePublic, \"text/turtle\")\r\n  }\r\n\r\n  public async addMetadata(triples: metadata[]) {\r\n    let query = `INSERT DATA { `\r\n\r\n    for (const triple of triples) {\r\n      let o\r\n      if (triple.object.startsWith(\"http\")) {\r\n        o = `<${triple.object}>`\r\n      } else {\r\n        o = `\"${triple.object}\"`\r\n      }\r\n      query += `<${triple.subject || this.url}> <${triple.predicate}> ${o} .`\r\n    }\r\n\r\n    query += `}`\r\n    await this.update(query)\r\n  }\r\n\r\n  public async getContainment(as: string = \"DCAT\", recursive: boolean = false) {\r\n    return new Promise(async (resolve, reject) => {\r\n      let data\r\n      try {\r\n        switch (as) {\r\n          case \"LDP\":\r\n            data = await this.getContainerStructure(LDP.contains, recursive)\r\n            break;\r\n          default:\r\n            data = await this.getContainerStructure(DCAT.dataset, recursive)\r\n        }\r\n        resolve(data)\r\n      } catch (error) {\r\n        reject(error)\r\n      }\r\n\r\n    })\r\n  }\r\n\r\n  public async getLocalSparqlEndpoint(): Promise<string> {\r\n    return await getSatelliteFromLdpResource(this.url, this.queryEngine)\r\n  }\r\n\r\n  public async aggregateSparqlEndpoints(): Promise<any[]> {\r\n    const satellite = await getSatelliteFromLdpResource(this.url, this.queryEngine)\r\n    const query = `PREFIX dcat: <http://www.w3.org/ns/dcat#>\r\n    PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\r\n    PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\r\n    SELECT ?ds WHERE {\r\n      <${this.url}> dcat:dataset ?ds .\r\n    }`\r\n    \r\n    const sources: any = [satellite]\r\n    const data = await this.queryEngine.queryBindings(query, {sources, session: this.session})\r\n    const bindings = await data.toArray().then(i => i.map(v => v.get('ds').value))\r\n    const satellites = new Set()\r\n\r\n    for (const ds of bindings) {\r\n      const sat = await getSatelliteFromLdpResource(ds, this.queryEngine)\r\n      if (sat !== satellite) satellites.add({satellite: sat, alias: ds})\r\n    }\r\n    satellites.add({satellite, alias: this.url})\r\n    return Array.from(satellites)\r\n  }\r\n\r\n  public async aggregate(): Promise<string[]> {\r\n    const satellite = await getSatelliteFromLdpResource(this.url, this.queryEngine)\r\n    const query = `PREFIX dcat: <http://www.w3.org/ns/dcat#>\r\n    PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\r\n    PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\r\n    SELECT ?ds WHERE {\r\n      ?sub dcat:dataset+ ?ds .\r\n    }`\r\n    const all:any = new Set()\r\n    \r\n    const sources: any = await this.aggregateSparqlEndpoints()\r\n    const data = await this.queryEngine.queryBindings(query, {sources, session: this.session})\r\n    const bindings = await data.toArray().then(i => i.map(v => v.get('ds').value))\r\n    const satellites = new Set()\r\n\r\n    for (const ds of bindings) {\r\n      const sat = await getSatelliteFromLdpResource(ds, this.queryEngine)\r\n      all.add(ds)\r\n      satellites.add(sat)\r\n    }\r\n    \r\n    const s = Array.from(satellites)\r\n    const d = await this.queryEngine.queryBindings(query, {sources: s, session: this.session})\r\n    const localDatasets = await d.toArray().then(i => i.map(v => v.get('ds').value))\r\n    localDatasets.forEach(ds => all.add(ds))\r\n\r\n    return Array.from(all)\r\n  }\r\n\r\n  private async getContainerStructure(predicate: string = DCAT.dataset, recursive: boolean = false) {\r\n    let engine\r\n    if (recursive) {\r\n      engine = this.queryEngine\r\n    } else {\r\n      engine = this.queryEngine\r\n    }\r\n\r\n    let queryStart\r\n    switch (predicate) {\r\n      case LDP.contains:\r\n        queryStart = `CONSTRUCT {\r\n          ?parent <${LDP.contains}> ?child , ?url\r\n        }`\r\n        break;\r\n      default:\r\n        queryStart = `CONSTRUCT {\r\n          ?parent <${DCAT.dataset}> ?child .\r\n          ?parent <${DCAT.distribution}> ?dist .\r\n          ?dist <${DCAT.downloadURL}> ?url\r\n        }`\r\n    }\r\n\r\n    const query = queryStart + `\r\n    WHERE {\r\n      {\r\n        ?parent <${DCAT.dataset}> ?child .\r\n      } UNION {\r\n        ?parent <${DCAT.distribution}> ?dist .\r\n        ?dist <${DCAT.downloadURL}> ?url .\r\n      }\r\n    }`\r\n\r\n    const quadStream = await engine.queryQuads(query, {\r\n      sources: [this.url],\r\n      fetch: this.fetch,\r\n      lenient: true\r\n    });\r\n\r\n    const textStream = rdfSerializer.serialize(quadStream, { contentType: 'text/turtle' });\r\n    const asTtl = await streamToString(textStream)\r\n    return asTtl\r\n  }\r\n\r\n  public async addDataset(datasetUrl = getRoot(this.url) + v4() ) {\r\n    let query = `INSERT DATA {<${this.url}> <${DCAT.dataset}> <${datasetUrl}> .}`\r\n    await this.update(query)\r\n    return datasetUrl\r\n  }\r\n\r\n  public async deleteDataset(datasetUrl) {\r\n    const query = `DELETE DATA {<${this.url}> <${DCAT.dataset}> <${datasetUrl}> .}`\r\n    await this.update(query)\r\n    await this.dataService.deleteFile(datasetUrl)\r\n  }\r\n\r\n  public async addDistribution(distributionUrl = getRoot(this.url) + v4(), triples: metadata[] = []) {\r\n    let query = `INSERT DATA {\r\n      <${this.url}> <${DCAT.distribution}> <${distributionUrl}> .\r\n      <${distributionUrl}> <${DCAT.downloadURL}> <${distributionUrl}> .`\r\n\r\n    for (const triple of triples) {\r\n      let o\r\n      if (triple.object.startsWith(\"http\")) {\r\n        o = `<${triple.object}>`\r\n      } else {\r\n        o = `\"${triple.object}\"`\r\n      }\r\n      query += `<${distributionUrl}> <${triple.predicate}> ${o} .`\r\n    }\r\n\r\n    query += `}`\r\n\r\n    await this.update(query)\r\n    return distributionUrl\r\n  }\r\n\r\n  public async deleteDistribution(distributionUrl) {\r\n    const query = `DELETE DATA {\r\n      <${this.url}> <${DCAT.distribution}> <${distributionUrl}> .\r\n      <${distributionUrl}> <${DCAT.downloadURL}> <${distributionUrl}> .\r\n  }`\r\n    await this.update(query)\r\n    await this.dataService.deleteFile(distributionUrl)\r\n  }\r\n\r\n  /**\r\n   * @description delete this catalog\r\n   * @returns void\r\n   */\r\n  public async delete() {\r\n    await this.dataService.deleteFile(this.url)\r\n    return\r\n  }\r\n\r\n  /**\r\n   * @description Update the dataset with SPARQL (dangerous - watch out!)\r\n   * @param query The SPARQL query with which to update the dataset\r\n   */\r\n  public async update(query) {\r\n    await this.dataService.sparqlUpdate(this.url, query)\r\n  }\r\n}\r\n\r\n"],"mappings":"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"}